# 数据字段理解修正说明

## 重要更新（2025年1月31日）

我们发现并修正了对原始数据字段含义的错误理解。

### 字段含义澄清

| 字段名 | 错误理解 | 正确理解 |
|--------|---------|----------|
| reportday | ❌ 财报截止日期 | ✅ 财报**公布日期** |
| tradingday | ❌ 财报发布日期 | ✅ 财报**截止日期**（名称误导） |
| d_year + d_quarter | - | ✅ 财报期间标识（最可靠） |

### 已修正的文件

1. **data/prepare_auxiliary_data.py**
   - 使用 d_year 和 d_quarter 计算财报期间作为索引
   - reportday 保存为 ReleasedDates 列

2. **factors/utils/data_adapter.py**
   - 修正了 prepare_financial_data 方法
   - 添加了 _get_report_period_date 辅助方法

3. **factors/base/time_series_processor.py**
   - expand_to_daily 函数已经正确处理同天发布的多份财报

### 数据结构说明

修正后的财务数据结构：
```
索引: MultiIndex
  - ReportDates (财报期间，根据d_year和d_quarter计算)
  - StockCodes (股票代码)
  
关键列:
  - ReleasedDates (财报公布日期，即原始的reportday)
  - d_year (财报年份)
  - d_quarter (财报季度，1-4)
  - 各种财务指标...
```

### 使用说明

1. **重新运行数据准备**
   ```bash
   python data/prepare_auxiliary_data.py
   ```

2. **使用数据适配器**
   ```python
   from factors.utils import DataAdapter
   prepared_data = DataAdapter.load_and_prepare_data(data_path)
   ```

3. **计算因子**
   ```python
   from factors.utils import FactorCalculator
   calculator = FactorCalculator()
   results = calculator.calculate_factors(
       factor_names=['BP'],
       financial_data=prepared_data['financial_data'],
       market_cap=prepared_data['market_cap'],
       release_dates=prepared_data['release_dates'],
       trading_dates=prepared_data['trading_dates']
   )
   ```

### 影响评估

这个修正会影响：
- ✅ 财报数据的正确对齐
- ✅ 时间序列指标（TTM、同比等）的准确性
- ✅ 同天发布多份财报时的正确处理
- ✅ 因子值的准确性

### 验证方法

验证数据是否正确：
```python
# 加载准备好的数据
financial_data = pd.read_pickle('data/auxiliary/FinancialData_unified.pkl')

# 检查一个样本
sample = financial_data.iloc[0]
print(f"索引（财报期间）: {financial_data.index[0][0]}")
print(f"d_year: {sample['d_year']}, d_quarter: {sample['d_quarter']}")
print(f"发布日期 (ReleasedDates): {sample['ReleasedDates']}")

# 验证财报期间是否正确
expected_period = f"{int(sample['d_year'])}-{int(sample['d_quarter'])*3:02d}-{[31,30,30,31][int(sample['d_quarter'])-1]}"
print(f"期望的财报期间: {expected_period}")
```

---
*此修正已应用到所有相关文件，无需使用V2版本*