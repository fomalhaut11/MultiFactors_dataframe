# 财报数据处理逻辑说明（修正版）

## 重要：字段含义澄清

经过确认，原始数据中的字段含义如下：
- **reportday**: 财报公布日期（不是截止日期）
- **tradingday**: 财报截止日期（命名容易误导）
- **d_year + d_quarter**: 财报所属期间（如2024年Q1）

## 关键设计决策

### 1. 索引结构

财务数据使用 **报表期间（ReportDates）** 作为主索引，通过 d_year 和 d_quarter 计算得出：

- **唯一性保证**：每个股票在每个报表期只有一份财报
- **时间序列完整性**：便于计算TTM、同比、环比等时间序列指标
- **数据对齐**：不同财务指标基于相同的报表期进行对齐

### 2. 发布日期处理

发布日期（ReleasedDates = reportday）作为数据列保存，用于：

- **信息时效性**：确定财报数据何时可用于交易决策
- **回测准确性**：避免使用未来信息
- **增量更新**：追踪新发布的财报

### 3. 同天发布多份财报的处理

当同一天发布多份财报时（如一季报和年报同天发布），处理逻辑如下：

```python
# 排序规则：先按发布日期，再按报表截止日期
stock_data = stock_data.sort_values(['ReleasedDates', 'ReportDates'])
```

这确保了：
- 同一天发布的财报中，**报表期间最新的优先**
- 例如：2024-04-30同时发布2024Q1和2023年报，使用2024Q1的数据

### 4. 数据展开到交易日

将季度财报数据展开到日频的逻辑：

1. **按发布日期生效**：财报数据从发布日期开始生效
2. **向前填充**：直到有新的财报发布
3. **覆盖规则**：新发布的财报覆盖旧数据

## 示例场景

### 场景1：正常情况
```
2024-04-28: 发布2024Q1财报
2024-04-29: 使用2024Q1数据
2024-04-30: 使用2024Q1数据
...
```

### 场景2：同天发布多份财报
```
2024-04-30: 同时发布2023年报和2024Q1
- 报表截止日期：2023-12-31 vs 2024-03-31
- 使用规则：2024Q1数据（更新的报表期）
2024-05-01: 使用2024Q1数据
...
```

### 场景3：财报更正
```
2024-04-28: 发布2024Q1初版
2024-05-10: 发布2024Q1更正版
- 两份财报的ReportDates相同
- 以发布日期更晚的为准
```

## 数据结构示例

### 原始财务数据
```
MultiIndex: (ReportDates, StockCodes)
Columns: [财务指标1, 财务指标2, ..., ReleasedDates]
```

### 展开后的日频数据
```
MultiIndex: (TradingDates, StockCodes)
Columns: [财务指标1, 财务指标2, ..., LatestReportDate]
```

## 注意事项

1. **数据完整性**：确保 ReleasedDates 列存在且准确
2. **时区处理**：所有日期统一使用相同时区
3. **缺失值处理**：没有财报的早期交易日为NaN
4. **性能优化**：大量数据时考虑分批处理

## 相关代码位置

- 数据准备：`data/prepare_auxiliary_data.py`
- 时间序列处理：`factors/base/time_series_processor.py`
- 数据适配器：`factors/utils/data_adapter.py`