# æ•°æ®ä¾èµ–å…³ç³»å›¾è°±

## ğŸ¯ ä¾èµ–å…³ç³»æ€»è§ˆ

### æ•°æ®æµå‘å›¾

```
                        ğŸ“Š æ•°æ®åº“æºå¤´
                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ä»·æ ¼æ•°æ®åº“   â”‚  â”‚ è´¢åŠ¡æ•°æ®åº“   â”‚  â”‚ å¸‚åœºæ•°æ®åº“   â”‚
    â”‚ StockDB     â”‚  â”‚ StockDB     â”‚  â”‚ StockDB     â”‚  
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â–¼                 â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ğŸ“¦ å¢é‡æ›´æ–°å™¨ â”‚  â”‚ğŸ“¦ å¢é‡æ›´æ–°å™¨ â”‚  â”‚ğŸ“¦ å¢é‡æ›´æ–°å™¨ â”‚
    â”‚PriceUpdater â”‚  â”‚FinancialUpd â”‚  â”‚MarketUpdaterâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â–¼                 â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ğŸ’¾ åŸºç¡€æ–‡ä»¶   â”‚  â”‚ğŸ’¾ åŸºç¡€æ–‡ä»¶   â”‚  â”‚ğŸ’¾ åŸºç¡€æ–‡ä»¶   â”‚
    â”‚ Price.pkl   â”‚  â”‚ fzb/lrb/    â”‚  â”‚ ST/Stop/    â”‚
    â”‚TradableDF   â”‚  â”‚ xjlb.pkl    â”‚  â”‚Sector.pkl   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ğŸ”§ æ•°æ®å¤„ç†å™¨ â”‚  â”‚ğŸ”§ æ•°æ®å¤„ç†å™¨ â”‚
              â”‚DataPipeline â”‚  â”‚Classificationâ”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                 â”‚
                     â–¼                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ğŸ“ˆ è¡ç”Ÿæ•°æ®   â”‚  â”‚ğŸ“Š åˆ†ç±»æ•°æ®   â”‚
              â”‚LogReturn_*  â”‚  â”‚StockClass_* â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ è¯¦ç»†ä¾èµ–è¡¨

### Level 0: æ•°æ®åº“è¡¨

| æ•°æ®åº“è¡¨å | ä¸»è¦å­—æ®µ | æ›´æ–°é¢‘ç‡ | æ•°æ®è§„æ¨¡ | æè¿° |
|-----------|----------|----------|----------|------|
| Price | tradingday, code, o, h, l, c, v, amt | æ¯æ—¥ | 1130ä¸‡+ | è‚¡ç¥¨ä»·æ ¼æ•°æ® |
| fzb | reportday, tradingday, code, èµ„äº§è´Ÿå€ºè¡¨å­—æ®µ | å­£åº¦ | 43ä¸‡+ | èµ„äº§è´Ÿå€ºè¡¨ |
| lrb | reportday, tradingday, code, åˆ©æ¶¦è¡¨å­—æ®µ | å­£åº¦ | 43ä¸‡+ | åˆ©æ¶¦è¡¨ |
| xjlb | reportday, tradingday, code, ç°é‡‘æµé‡è¡¨å­—æ®µ | å­£åº¦ | 43ä¸‡+ | ç°é‡‘æµé‡è¡¨ |
| StopPrice | tradingday, code, limit_up, limit_down | æ¯æ—¥ | 1450ä¸‡+ | æ¶¨è·Œåœä»·æ ¼ |
| ST_stocks | tradingday, code, st_type, change_type | ä¸å®šæœŸ | 68ä¸‡+ | STè‚¡ç¥¨çŠ¶æ€ |
| SectorChanges | sel_day, code, concept_code, action | ä¸å®šæœŸ | 625 | æ¿å—è°ƒæ•´ |

### Level 1: åŸºç¡€æ•°æ®æ–‡ä»¶

| æ–‡ä»¶å | æ›´æ–°å™¨ | ä¾èµ–æº | å­—æ®µæ•° | ç´¢å¼•ç»“æ„ | æ›´æ–°è§¦å‘æ¡ä»¶ |
|--------|--------|--------|--------|----------|-------------|
| Price.pkl | PriceDataUpdater | Priceè¡¨ | 16 | (TradingDates, StockCodes) | æœ¬åœ°æ—¥æœŸ < æ•°æ®åº“æ—¥æœŸ |
| TradableDF.pkl | PriceDataUpdater | Priceè¡¨(trade_status) | 4 | (TradingDates, StockCodes) | ä¸Price.pklåŒæ­¥ |
| fzb.pkl | FinancialDataUpdater | fzbè¡¨ | 140 | å•å±‚ç´¢å¼• | local_dateæ£€æŸ¥ |
| lrb.pkl | FinancialDataUpdater | lrbè¡¨ | 140 | å•å±‚ç´¢å¼• | local_dateæ£€æŸ¥ |
| xjlb.pkl | FinancialDataUpdater | xjlbè¡¨ | 140 | å•å±‚ç´¢å¼• | local_dateæ£€æŸ¥ |
| StopPrice.pkl | StopPriceDataUpdater | StopPriceè¡¨ | 4 | (TradingDates, StockCodes) | æœ¬åœ°æ—¥æœŸ < æ•°æ®åº“æ—¥æœŸ |
| ST_stocks.pkl | STDataUpdater | ST_stocksè¡¨ | 4 | å•å±‚ç´¢å¼• | 30å¤©æ›´æ–°é—´éš” |
| SectorChanges_data.pkl | SectorChangesDataUpdater | SectorChangesè¡¨ | å¤šåˆ— | å•å±‚ç´¢å¼• | sel_dayæ£€æŸ¥ |

### Level 2: å¤„ç†æ•°æ®æ–‡ä»¶

| æ–‡ä»¶å | å¤„ç†å™¨ | ç›´æ¥ä¾èµ– | é—´æ¥ä¾èµ– | ç”Ÿæˆæ¡ä»¶ | æ•°æ®ç»“æ„ |
|--------|--------|----------|----------|----------|----------|
| Stock3d.pkl | PriceDataProcessor | Price.pkl, TradableDF.pkl | Priceè¡¨ | Price.pklæ›´æ–°å | 3DçŸ©é˜µ |
| LogReturn_daily_o2o.pkl | ReturnCalculator | Price.pkl | Priceè¡¨ | æŒ‰éœ€è§¦å‘ | (TradingDates, StockCodes) |
| LogReturn_daily_vwap.pkl | ReturnCalculator | Price.pkl | Priceè¡¨ | æŒ‰éœ€è§¦å‘ | (TradingDates, StockCodes) |
| LogReturn_5days_o2o.pkl | ReturnCalculator | Price.pkl | Priceè¡¨ | æŒ‰éœ€è§¦å‘ | (TradingDates, StockCodes) |
| LogReturn_20days_o2o.pkl | ReturnCalculator | Price.pkl | Priceè¡¨ | æŒ‰éœ€è§¦å‘ | (TradingDates, StockCodes) |
| LogReturn_weekly_o2o.pkl | ReturnCalculator | Price.pkl | Priceè¡¨ | æŒ‰éœ€è§¦å‘ | (TradingDates, StockCodes) |
| LogReturn_monthly_o2o.pkl | ReturnCalculator | Price.pkl | Priceè¡¨ | æŒ‰éœ€è§¦å‘ | (TradingDates, StockCodes) |
| StockClassification_*.pkl | SectorClassificationProcessor | SectorChanges_data.pkl | SectorChangesè¡¨ | æŒ‰éœ€è§¦å‘ | MultiIndex |

## ğŸ”— å…³é”®ä¾èµ–é“¾è·¯

### 1. ä»·æ ¼æ•°æ®é“¾

```
StockDB.Price
    â†“ (IncrementalPriceUpdater)
Price.pkl + TradableDF.pkl
    â†“ (PriceDataProcessor)
Stock3d.pkl
    â†“ (ReturnCalculator)
LogReturn_*.pkl (6ä¸ªæ–‡ä»¶)
```

**å…³é”®èŠ‚ç‚¹**:
- `TradableDF.pkl`: å¿…é¡»ä¸Price.pklåŒæ­¥ï¼Œæä¾›äº¤æ˜“çŠ¶æ€è¿‡æ»¤
- `Stock3d.pkl`: 3DçŸ©é˜µæ ¼å¼ï¼Œæ”¶ç›Šç‡è®¡ç®—çš„å¿…è¦ä¸­é—´æ ¼å¼

### 2. è´¢åŠ¡æ•°æ®é“¾

```
StockDB.{fzb, lrb, xjlb}
    â†“ (IncrementalFinancialUpdater)
{fzb, lrb, xjlb}.pkl
    â†“ (FinancialDataProcessor)
released_dates_df + DateCount_df
    â†“ (å› å­ç”Ÿæˆå™¨ - æœªæ¥æ‰©å±•)
FinancialFactors_*.pkl
```

**å…³é”®èŠ‚ç‚¹**:
- ä¸‰è¡¨å¿…é¡»åŒæ­¥æ›´æ–°ï¼ˆå…±äº«local_dateå­—æ®µï¼‰
- `tradingday`å­—æ®µæä¾›è´¢æŠ¥å‘å¸ƒæ—¥æœŸä¿¡æ¯

### 3. åˆ†ç±»æ•°æ®é“¾

```
StockDB.SectorChanges
    â†“ (SectorChangesDataUpdater)
SectorChanges_data.pkl
    â†“ (SectorClassificationProcessor)
StockClassification_*.pkl
```

**å…³é”®èŠ‚ç‚¹**:
- æ¿å—è°ƒæ•´æ•°æ®æ›´æ–°é¢‘ç‡è¾ƒä½
- åˆ†ç±»ä¿¡æ¯æŒ‰éœ€è®¡ç®—ï¼Œä¸éœ€è¦å®æ—¶æ›´æ–°

## âš ï¸ ä¾èµ–é£é™©ä¸ç¼“è§£

### é«˜é£é™©ä¾èµ–

1. **Price.pkl â†’ TradableDF.pkl**
   - **é£é™©**: TradableDFç¼ºå¤±ä¼šå¯¼è‡´äº¤æ˜“çŠ¶æ€è¿‡æ»¤å¤±è´¥
   - **ç¼“è§£**: PriceDataProcessorå·²ä¿®æ”¹ä¸ºå¯é€‰ä¾èµ–ï¼Œç¼ºå¤±æ—¶è·³è¿‡è¿‡æ»¤

2. **è´¢åŠ¡ä¸‰è¡¨åŒæ­¥**
   - **é£é™©**: æŸä¸ªè¡¨æ›´æ–°å¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
   - **ç¼“è§£**: IncrementalFinancialUpdaterä½¿ç”¨äº‹åŠ¡æ€§æ“ä½œ

3. **æ•°æ®åº“è¿æ¥ä¸­æ–­**
   - **é£é™©**: æ›´æ–°è¿‡ç¨‹ä¸­æ•°æ®åº“è¿æ¥ä¸¢å¤±
   - **ç¼“è§£**: è¿æ¥æ± è‡ªåŠ¨é‡è¿ + å¤‡ä»½æœºåˆ¶

### ä¸­é£é™©ä¾èµ–

1. **Stock3d.pklæ ¼å¼é”™è¯¯**
   - **é£é™©**: 3DçŸ©é˜µreshapeå¤±è´¥
   - **ç¼“è§£**: æ•°æ®éªŒè¯ + é”™è¯¯æ—¥å¿—è®°å½•

2. **æ—¥æœŸæ ¼å¼ä¸ä¸€è‡´**
   - **é£é™©**: MultiIndexæ„å»ºå¤±è´¥
   - **ç¼“è§£**: ç»Ÿä¸€çš„æ—¥æœŸå¤„ç†å‡½æ•°

### ä½é£é™©ä¾èµ–

1. **STæ•°æ®æ›´æ–°é—´éš”é•¿**
   - **é£é™©**: æ•°æ®å¯èƒ½è¿‡æ—¶
   - **å½±å“**: æœ‰é™ï¼ŒSTçŠ¶æ€å˜åŒ–é¢‘ç‡ä½

## ğŸ”§ ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ

### 1. æ›´æ–°é¡ºåº

æ¨èæŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œæ›´æ–°ï¼š

```python
# 1. åŸºç¡€æ•°æ®æ›´æ–°ï¼ˆå¯å¹¶è¡Œï¼‰
python scheduled_data_updater.py --data-type price
python scheduled_data_updater.py --data-type financial  
python scheduled_data_updater.py --data-type stop_price

# 2. å¸‚åœºæ•°æ®æ›´æ–°ï¼ˆå¯å¹¶è¡Œï¼‰
python scheduled_data_updater.py --data-type st
python scheduled_data_updater.py --data-type sector_changes

# 3. å¤„ç†æ•°æ®ç”Ÿæˆï¼ˆä¾èµ–åŸºç¡€æ•°æ®ï¼‰
python -c "from data.processor.data_processing_pipeline import DataProcessingPipeline; DataProcessingPipeline().run_full_pipeline()"
```

### 2. ä¾èµ–æ£€æŸ¥

```python
from core.data_registry import get_data_registry

registry = get_data_registry()

# æ£€æŸ¥ä¾èµ–å…³ç³»
for dataset_name in ['logreturn_daily_o2o']:
    dataset = registry.get_dataset_info(dataset_name)
    if dataset.dependencies:
        print(f"{dataset_name} ä¾èµ–: {dataset.dependencies}")
        for dep in dataset.dependencies:
            dep_info = registry.get_dataset_info(dep)
            print(f"  -> {dep}: {'å¯ç”¨' if dep_info.is_available else 'ä¸å¯ç”¨'}")
```

### 3. æ•…éšœæ¢å¤

```bash
# æ£€æŸ¥ç¼ºå¤±çš„ä¾èµ–
python scheduled_data_updater.py --list-data | grep "ä¸å¯ç”¨"

# å¼ºåˆ¶é‡æ–°ç”Ÿæˆä¾èµ–æ•°æ®
python scheduled_data_updater.py --data-type price --force

# éªŒè¯æ•°æ®å®Œæ•´æ€§
python -c "
from core.data_registry import get_data_registry
registry = get_data_registry()
missing = registry.get_missing_datasets()
if missing:
    print('ç¼ºå¤±æ•°æ®é›†:', missing)
else:
    print('æ‰€æœ‰æ•°æ®é›†å¯ç”¨')
"
```

## ğŸ“Š ä¾èµ–ç›‘æ§

### ç›‘æ§æŒ‡æ ‡

1. **æ•°æ®æ–°é²œåº¦**: æ£€æŸ¥å„æ–‡ä»¶æœ€åæ›´æ–°æ—¶é—´
2. **ä¾èµ–å®Œæ•´æ€§**: éªŒè¯æ‰€æœ‰ä¾èµ–æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. **æ•°æ®ä¸€è‡´æ€§**: æ£€æŸ¥å…³è”æ•°æ®çš„æ—¶é—´èŒƒå›´ä¸€è‡´æ€§
4. **æ›´æ–°æˆåŠŸç‡**: ç»Ÿè®¡æ›´æ–°æ“ä½œçš„æˆåŠŸ/å¤±è´¥æ¯”ä¾‹

### è‡ªåŠ¨åŒ–ç›‘æ§

```python
# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡
def dependency_health_check():
    registry = get_data_registry()
    
    # æ£€æŸ¥æ•°æ®æ–°é²œåº¦
    freshness = registry.check_data_freshness(hours_threshold=24)
    
    # æ£€æŸ¥ç¼ºå¤±æ•°æ®
    missing = registry.get_missing_datasets()
    
    # ç”ŸæˆæŠ¥å‘Š
    if missing or not all(freshness.values()):
        # å‘é€å‘Šè­¦
        alert_admin("æ•°æ®ä¾èµ–å¥åº·æ£€æŸ¥å¤±è´¥")
```

---

**ç»´æŠ¤è¯´æ˜**: 
- æ–°å¢æ•°æ®æºæ—¶ï¼Œå¿…é¡»æ›´æ–°æ­¤ä¾èµ–å›¾è°±
- ä¿®æ”¹ä¾èµ–å…³ç³»æ—¶ï¼Œéœ€è¦åŒæ­¥æ›´æ–°æ³¨å†Œå™¨é…ç½®
- å®šæœŸreviewä¾èµ–å…³ç³»çš„åˆç†æ€§å’Œå¿…è¦æ€§